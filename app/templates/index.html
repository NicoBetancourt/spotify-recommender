<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            background-color: #91ef6590;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        table {
            border: 1px solid #f91919;
            border-collapse: collapse;
            margin-bottom: 20px;
            width: 100%;
        }

        .rounded-table {
            border-radius: 10px;  /* Adjust the radius as needed */
            overflow: hidden;    /* Ensures the content respects the border radius */
        }
        
        /* Spotify color scheme */
        .spotify-table {
            background-color: #1DB954; /* Spotify Green */
            color: black; /* Text color for the table */
        }

        .spotify-table thead {
            background-color: #191414; /* Spotify Dark Grey */
            color: #FFFFFF; /* White text for the header */
        }

        .spotify-table td,
        .spotify-table th {
            border: none !important; /* Remove cell borders */
        }

        #searchInput {
            width: 100%;
            max-width: 400px;
        }

        .btn-song-action {
            width: 30px;  /* Set the desired width */
            height: 30px; /* Set the desired height */
            display: flex;        /* Use flexbox for alignment */
            justify-content: center; /* Center horizontally */
            align-items: center;  /* Center vertically */
            padding: 0; /* Remove padding to ensure proper centering */
        }  

        /* Spotify color scheme */
        .spotify-table {
            background-color: #1DB954; /* Spotify Green */
            color: black; /* Text color for the table */
        }

        .spotify-table thead {
            background-color: #191414; /* Spotify Dark Grey */
            color: #FFFFFF; /* White text for the header */
        }

        /* Nuevos estilos para el botón de editar */
        .btn-edit-action {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1>Spotify Search</h1>

        <form id="searchForm">
            <div class="mb-3">
                <label for="searchInput" class="form-label">Nombre de la canción:</label>
                <input type="text" class="form-control" id="searchInput" name="id" maxlength="50" required>
            </div>
            <button type="button" class="btn btn-primary" onclick="searchSpotify()">Search</button>
        </form>

        <div class="row">
            <!-- Tabla de resultados -->
            <div class="col-lg-6 col-md-12">
                <div class="table-container">
                    <h2>Resultados de Búsqueda</h2>
                    <div id="results"></div>
                </div>
            </div>

            <!-- Columna para Canciones Seleccionadas y Recomendaciones -->
            <div class="col-lg-6 col-md-12">
                <!-- Tabla de Canciones Seleccionadas -->
                <div class="table-container">
                    <h2>Canciones Seleccionadas</h2>
                    <div id="selectedResults"></div>
                </div>

                <!-- Tabla de Recomendaciones -->
                <div class="table-container">
                    <h2>Recomendaciones</h2>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal">
            Editar Resultados
        </button>

        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Editar Resultados</h5>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="mb-3">
                                <label for="editName" class="form-label">Nombre de la canción:</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>

                            <div class="mb-3">
                                <label for="editArtist" class="form-label">Artista:</label>
                                <input type="text" class="form-control" id="editArtist" required>
                            </div>

                            <div class="mb-3">
                                <label for="editAlbum" class="form-label">Álbum:</label>
                                <input type="text" class="form-control" id="editAlbum" required>
                            </div>

                            <div class="mb-3">
                                <label for="editGenre" class="form-label">Género:</label>
                                <input type="text" class="form-control" id="editGenre" required>
                            </div>

                            <div class="mb-3">
                                <label for="editReleaseDate" class="form-label">Fecha de lanzamiento:</label>
                                <input type="text" class="form-control" id="editReleaseDate" required>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar Cambios</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        function searchSpotify() {
            var id = document.getElementById("searchInput").value;
            var url = "http://localhost:5000/v1/spotify/?track_name=" + id;

            fetch(url)
                .then(response => response.json())
                .then(data => displayResults(filterColumns(data)))
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching data. Please try again.');
                });

        }

        function filterColumns(dataComplete) {
            data = dataComplete.song;
            console.log("🚀 ~ file: index.html:39 ~ filterColumns ~ data:", data)
            var filteredData = [];
            for (var i = 0; i < data.length; i++) {
                var row = {};
                row["track_name"] = data[i]["track_name"];
                row["track_artist"] = data[i]["track_artist"];
                row["track_album_name"] = data[i]["track_album_name"];
                row["playlist_genre"] = data[i]["playlist_genre"];
                row["track_album_release_date"] = data[i]["track_album_release_date"];
                filteredData.push(row);
            }
            return filteredData;
        }

        function displayResults(data) {
            var resultsDiv = document.getElementById("results");
            var selectedDiv = document.getElementById("selectedResults");
            var recommendationsDiv = document.getElementById("recommendations");

            // Limpiar resultados anteriores
            resultsDiv.innerHTML = "";
            selectedDiv.innerHTML = "";
            recommendationsDiv.innerHTML = "<h2>Recomendaciones</h2>";

            // Crear una tabla con estilos de Bootstrap
            var table = document.createElement("table");
            table.classList.add("table", "rounded-table", "table-striped");

            // Crear encabezados de tabla con 6 columnas específicas
            var headerRow = table.insertRow(0);
            var columnHeaders = ["", "Name", "Artista", "Álbum", "Género", "Fecha"];
            for (var i = 0; i < columnHeaders.length; i++) {
                var headerCell = headerRow.insertCell(-1);
                headerCell.textContent = columnHeaders[i];
            }

            var numRowsToDisplay = 15;

            // Llenar la tabla con los datos
            for (var i = 0; i < Math.min(numRowsToDisplay, data.length); i++) {
                var row = table.insertRow(-1);

                // Crear botónes de selección y deselección
                var selectCell = row.insertCell(0);
                let selectButton = document.createElement("button");
                let deselectButton = document.createElement("button");

                // Estilo de los botones
                selectButton.classList.add("btn", "btn-success", "btn-song-action");
                selectButton.textContent = "+";
                deselectButton.classList.add("btn", "btn-danger", "btn-song-action");
                deselectButton.textContent = "-";
                // Ocultar boto de deseleccion si la lista está vacia o no contiene la canción
                if(isSongSelected(data[i]))
                {
                    selectButton.style.display = "none"; // Ocultar botón de selección
                    deselectButton.style.display = "inline-block"; // Mostrar botón de deselección
                }
                else
                {
                    selectButton.style.display = "inline-block"; // Mostrar botón de selección
                    deselectButton.style.display = "none"; // Ocultar botón de deselección
                }


                // Utilizar una función de cierre para capturar el valor de i
                selectButton.onclick = (function (index) {
                    return function () {
                        selectButton.style.display = "none"; 
                        deselectButton.style.display = "inline-block";
                        addToSelected(data[index]);
                    };
                })(i);

                deselectButton.onclick = (function (index) {
                    return function () {
                        selectButton.style.display = "inline-block";
                        deselectButton.style.display = "none";
                        removeFromSelected(data[index]);
                    };
                })(i);

                selectCell.appendChild(selectButton);
                selectCell.appendChild(deselectButton);

                // Llenar las restantes 5 columnas con datos
                for (var j = 0; j < 5; j++) {
                    var cell = row.insertCell(-1);
                    cell.textContent = data[i][Object.keys(data[i])[j]];
                }
            } 

            // Agregar la tabla al div de resultados
            resultsDiv.appendChild(table);

            // Inicializar tabla de canciones seleccionadas 
            updateSelectedTable();
        }

        // Lista de canciones seleccionadas
        var selectedSongs = [];
        // Agregar canción seleccionada a la lista
        function addToSelected(selectedData) {
            // Add song to the list
            selectedSongs.push(selectedData);
            // Update table
            updateSelectedTable();
        }

        function removeFromSelected(song, index) {
        selectedSongs.splice(index, 1); // Remove the song
        updateSelectedTable(); // Update the table

        // Additionally, update the corresponding button in the results table
        updateResultsButtonState(song, false);
        }

        function updateSelectedTable() {
        var selectedDiv = document.getElementById("selectedResults");
        selectedDiv.innerHTML = "";

        // If no songs are selected, display a message
        if (selectedSongs.length === 0) {
            selectedDiv.innerHTML = "<p>No hay canciones seleccionadas</p>";
            return;
        }

        // Create a table
        var selectedTable = document.createElement("table");
        selectedTable.classList.add("table", "rounded-table", "table-striped");

        // Add table header
        var headerRow = selectedTable.insertRow(-1);
        ["", "Name", "Artista"].forEach(headerText => {
            var headerCell = headerRow.insertCell(-1);
            headerCell.textContent = headerText;
        });

        // Add rows for each selected song
        selectedSongs.forEach((song, index) => {
            var row = selectedTable.insertRow(-1);
            addRowToSelectedTable(row, song, index);
        });

        selectedDiv.appendChild(selectedTable);
    }

    function addRowToSelectedTable(row, song, index) {
        // Deselect button
        var deselectCell = row.insertCell(0);
        var deselectButton = document.createElement("button");
        deselectButton.classList.add("btn", "btn-danger", "btn-song-action");
        deselectButton.textContent = "-";
        deselectButton.onclick = () => removeFromSelected(song, index);
        deselectCell.appendChild(deselectButton);

        // Song name and artist
        var nameCell = row.insertCell(-1);
        nameCell.textContent = song.track_name;
        var artistCell = row.insertCell(-1);
        artistCell.textContent = song.track_artist;
    }

    function updateResultsButtonState(song, isSelected) {
        var rows = document.querySelectorAll("#results table tr");
        rows.forEach((row, index) => {
            if (index === 0) return; // Skip the header row

            // Assuming the first two cells contain the song name and artist
            var songName = row.cells[1].textContent;
            var artistName = row.cells[2].textContent;

            if (song.track_name === songName && song.track_artist === artistName) {
                var selectButton = row.cells[0].querySelector("button.btn-success");
                var deselectButton = row.cells[0].querySelector("button.btn-danger");

                // Update button visibility based on whether the song is selected
                selectButton.style.display = isSelected ? "none" : "inline-block";
                deselectButton.style.display = isSelected ? "inline-block" : "none";
            }
        });
    }

    // Comprobar si la canción ya está seleccionada
    function isSongSelected(song) {
        // Si la lista está vacia, no hay canciones seleccionadas
        if(selectedSongs.length == 0)
            return false;

        for (var i = 0; i < selectedSongs.length; i++) {
            if (selectedSongs[i].track_name === song.track_name && selectedSongs[i].track_artist === song.track_artist) {
                return true;
            }
        }
        return false;
    }

    // Nueva función para abrir el modal de edición con los datos del resultado seleccionado
    function openEditModal(index) {
        editIndex = index;
        var result = data[index];

        document.getElementById("editName").value = result.track_name;
        document.getElementById("editArtist").value = result.track_artist;
        // Agrega más líneas para otros campos

        // Inicializa el modal antes de mostrarlo
        var editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
}

    // Nueva función para guardar los cambios editados
    function saveEdit() {
    var newName = document.getElementById("editName").value;
    var newArtist = document.getElementById("editArtist").value;
    var newAlbum = document.getElementById("editAlbum").value;
    var newGenre = document.getElementById("editGenre").value;
    var newReleaseDate = document.getElementById("editReleaseDate").value;

    // Validate that required fields are not empty
    if (!newName || !newArtist || !newAlbum || !newGenre || !newReleaseDate) {
        alert("Please fill in all the fields.");
        return;
    }

        data[editIndex].track_name = newName;
        data[editIndex].track_artist = newArtist;
        data[editIndex].track_album_name = newAlbum;
        data[editIndex].track_genre = newGenre;
        data[editIndex].track_album_release_date = newReleaseDate;

        var editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.hide();

        displayResults(data);
    }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>

</html>
